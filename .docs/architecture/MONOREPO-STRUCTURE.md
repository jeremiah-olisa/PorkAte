# Monorepo Structure Documentation

## Overview

The PorkAte monorepo is organized using **Lerna** + **PNPM workspaces** to manage multiple packages with different lifecycles and publishing schedules.

## Architecture Philosophy

### Three-Tier Package Structure

```
porkate-monorepo/
‚îú‚îÄ‚îÄ packages/               # Core PorkAte packages (tightly coupled)
‚îú‚îÄ‚îÄ standalone-packages/    # Extraction-ready packages (loosely coupled)
‚îî‚îÄ‚îÄ examples/              # Usage examples
```

### Package Independence Levels

1. **Core Packages** (`packages/`)
   - Tightly coupled to PorkAte
   - Cannot be extracted without breaking changes
   - Published together as PorkAte releases
   
2. **Standalone Packages** (`standalone-packages/`)
   - **Extraction-ready**: Can move to separate repos with ZERO changes
   - Independent versioning and publishing
   - No direct dependencies on PorkAte core
   - Use workspace protocol for inter-standalone dependencies

3. **Examples** (`examples/`)
   - Not published
   - Demonstrate usage patterns

---

## Directory Structure

```
porkate-monorepo/
‚îÇ
‚îú‚îÄ‚îÄ lerna.json                      # Lerna configuration
‚îú‚îÄ‚îÄ pnpm-workspace.yaml             # PNPM workspace definition
‚îú‚îÄ‚îÄ package.json                    # Root package.json
‚îú‚îÄ‚îÄ tsconfig.base.json              # Base TypeScript config
‚îú‚îÄ‚îÄ .eslintrc.js                    # ESLint config
‚îú‚îÄ‚îÄ .prettierrc                     # Prettier config
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ README.md
‚îÇ
‚îú‚îÄ‚îÄ packages/                       # Core PorkAte packages
‚îÇ   ‚îú‚îÄ‚îÄ core/                       # @porkate/core
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schema.zmodel           # ZenStack schema
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ README.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jest.config.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ wallet-sdk.module.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ constants/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ interfaces/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ wallet/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ transaction/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ kyc/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lien/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ledger/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ providers/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ database/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ common/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prisma/                 # Generated by ZenStack
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma       # Auto-generated
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ seeds/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ e2e/
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ nosql/                      # @porkate/nosql
‚îÇ       ‚îú‚îÄ‚îÄ package.json
‚îÇ       ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ       ‚îú‚îÄ‚îÄ README.md
‚îÇ       ‚îú‚îÄ‚îÄ src/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ index.ts
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ interfaces/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ cassandra/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ mongodb/
‚îÇ       ‚îî‚îÄ‚îÄ test/
‚îÇ
‚îú‚îÄ‚îÄ standalone-packages/            # Extraction-ready packages
‚îÇ   ‚îú‚îÄ‚îÄ invalid8/                   # @invalid8/core
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json            # ‚úÖ Complete, standalone
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LICENSE                 # ‚úÖ Own MIT license
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ README.md               # ‚úÖ Full documentation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .npmignore              # ‚úÖ Publishing config
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jest.config.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ query-client.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ invalid8.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ adapters/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ memory/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ redis/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ interfaces/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ integration/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ docs/
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ townkrier/                  # @townkrier/core
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json            # ‚úÖ Complete, standalone
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LICENSE                 # ‚úÖ Own MIT license
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ README.md               # ‚úÖ Full documentation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .npmignore
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jest.config.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ event-bus.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ townkrier.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ adapters/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ memory/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rabbitmq/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ kafka/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ interfaces/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ docs/
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ kolo/                       # @kolo/core
‚îÇ       ‚îú‚îÄ‚îÄ package.json            # ‚úÖ Complete, standalone
‚îÇ       ‚îú‚îÄ‚îÄ LICENSE                 # ‚úÖ Own MIT license
‚îÇ       ‚îú‚îÄ‚îÄ README.md               # ‚úÖ Full documentation
‚îÇ       ‚îú‚îÄ‚îÄ .npmignore
‚îÇ       ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ       ‚îú‚îÄ‚îÄ jest.config.js
‚îÇ       ‚îú‚îÄ‚îÄ src/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ index.ts
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ storage-client.ts
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ kolo.ts
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ adapters/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ local/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ s3/
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ azure/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ interfaces/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ test/
‚îÇ       ‚îî‚îÄ‚îÄ docs/
‚îÇ
‚îú‚îÄ‚îÄ examples/
‚îÇ   ‚îú‚îÄ‚îÄ porkate-basic/
‚îÇ   ‚îú‚îÄ‚îÄ porkate-nestjs/
‚îÇ   ‚îú‚îÄ‚îÄ porkate-express/
‚îÇ   ‚îú‚îÄ‚îÄ invalid8-usage/
‚îÇ   ‚îú‚îÄ‚îÄ townkrier-usage/
‚îÇ   ‚îî‚îÄ‚îÄ kolo-usage/
‚îÇ
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ product/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PorkAte-FRD.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PorkAte-TRD.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PorkAte-TODO.md
‚îÇ   ‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ invalid8/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ townkrier/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ kolo/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ README.md
‚îÇ   ‚îú‚îÄ‚îÄ migration/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PACKAGE-MIGRATION-GUIDE.md
‚îÇ   ‚îú‚îÄ‚îÄ architecture/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MONOREPO-STRUCTURE.md (this file)
‚îÇ   ‚îî‚îÄ‚îÄ guides/
‚îÇ
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ migration/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ extract-package.sh
‚îÇ   ‚îú‚îÄ‚îÄ setup/
‚îÇ   ‚îî‚îÄ‚îÄ publishing/
‚îÇ
‚îî‚îÄ‚îÄ .github/
    ‚îî‚îÄ‚îÄ workflows/
        ‚îú‚îÄ‚îÄ ci.yml
        ‚îú‚îÄ‚îÄ publish-core.yml
        ‚îú‚îÄ‚îÄ publish-invalid8.yml
        ‚îú‚îÄ‚îÄ publish-townkrier.yml
        ‚îî‚îÄ‚îÄ publish-kolo.yml
```

---

## Package Dependency Graph

```mermaid
graph TD
    A[@porkate/core] --> B[@invalid8/core]
    A --> C[@townkrier/core]
    A --> D[@kolo/core]
    A --> E[@porkate/nosql]
    B --> C
    
    style A fill:#e1f5ff
    style B fill:#fff3cd
    style C fill:#fff3cd
    style D fill:#fff3cd
    style E fill:#e1f5ff
    
    classDef extractable fill:#fff3cd,stroke:#856404
    class B,C,D extractable
```

**Legend:**
- üîµ Blue = Core packages (non-extractable)
- üü° Yellow = Standalone packages (extraction-ready)

---

## Workspace Dependencies

### Workspace Protocol

Standalone packages use `workspace:*` protocol for inter-package dependencies:

```json
// @invalid8/core package.json
{
  "dependencies": {
    "@townkrier/core": "workspace:*"
  }
}
```

**Benefits:**
- Development: Uses local package versions
- Publishing: Replaced with actual version numbers
- Extraction: Simply remove and install from npm

### Post-Extraction Dependencies

After extracting a package to a separate repo:

```json
// Before extraction (in monorepo)
{
  "dependencies": {
    "@townkrier/core": "workspace:*"
  }
}

// After extraction (in PorkAte)
{
  "dependencies": {
    "@townkrier/core": "^1.0.0"
  }
}
```

---

## ZenStack Multi-Provider Support

### Problem Solved

Traditional Prisma requires hardcoding the database provider in `schema.prisma`:

```prisma
datasource db {
  provider = "postgresql"  // ‚ùå Hardcoded
  url      = env("DATABASE_URL")
}
```

### ZenStack Solution

ZenStack uses `schema.zmodel` with runtime provider selection:

```zmodel
datasource db {
  provider = env("DATABASE_PROVIDER")  // ‚úÖ Runtime selection
  url      = env("DATABASE_URL")
}
```

### Workflow

1. Define schema in `schema.zmodel`
2. Set `DATABASE_PROVIDER` environment variable
3. Run `zenstack generate`
4. ZenStack generates `prisma/schema.prisma` with correct provider
5. Run `prisma migrate dev` or `prisma generate`

### Example

```bash
# Use PostgreSQL
export DATABASE_PROVIDER=postgresql
export DATABASE_URL="postgresql://..."
pnpm zenstack:generate

# Use MySQL
export DATABASE_PROVIDER=mysql
export DATABASE_URL="mysql://..."
pnpm zenstack:generate

# Use SQLite
export DATABASE_PROVIDER=sqlite
export DATABASE_URL="file:./dev.db"
pnpm zenstack:generate
```

### Supported Providers

- `postgresql` (recommended)
- `mysql`
- `sqlite`
- `sqlserver`
- `cockroachdb`

---

## Publishing Strategy

### Independent Versioning

Each package maintains its own version:

```json
// lerna.json
{
  "version": "independent"
}
```

### Publishing Workflows

#### Core Packages

```bash
# Version and publish all core packages together
lerna version --conventional-commits
lerna publish from-package
```

#### Standalone Packages

```bash
# Publish individual standalone package
lerna publish --scope=@invalid8/core from-package

# Or publish all standalone packages
lerna publish --scope=@invalid8/* --scope=@townkrier/* --scope=@kolo/* from-package
```

### GitHub Actions

Each standalone package has its own publishing workflow:

- `.github/workflows/publish-invalid8.yml`
- `.github/workflows/publish-townkrier.yml`
- `.github/workflows/publish-kolo.yml`

---

## Development Workflow

### Setup

```bash
# Clone repository
git clone https://github.com/jeremiah-olisa/porkate.git
cd porkate

# Install dependencies
pnpm install

# Build all packages
pnpm build
```

### Working on Core

```bash
# Navigate to core package
cd packages/core

# Configure database
cp .env.example .env
# Edit .env: Set DATABASE_PROVIDER and DATABASE_URL

# Generate Prisma schema
pnpm zenstack:generate

# Run migrations
pnpm prisma:migrate

# Start development
pnpm dev
```

### Working on Standalone Packages

```bash
# Navigate to package
cd standalone-packages/invalid8

# Install dependencies (already done by root install)
# Build
pnpm build

# Run tests
pnpm test

# Watch mode
pnpm watch
```

### Cross-Package Development

When developing across packages:

```bash
# Build all packages
pnpm build

# Or build specific package
pnpm build:invalid8
pnpm build:townkrier
pnpm build:kolo
pnpm build:core
```

---

## Testing Strategy

### Unit Tests

Each package has its own test suite:

```bash
# Test all packages
pnpm test

# Test specific package
cd standalone-packages/invalid8
pnpm test
```

### Integration Tests

Test cross-package interactions:

```bash
cd packages/core
pnpm test:integration
```

### E2E Tests

Test complete workflows:

```bash
cd examples/porkate-nestjs
pnpm test:e2e
```

---

## Extraction Checklist

Before extracting a standalone package to a separate repository:

### ‚úÖ Pre-Extraction Checklist

- [ ] Package has own `package.json` with complete metadata
- [ ] Package has own `README.md` with usage instructions
- [ ] Package has own `LICENSE` file
- [ ] Package has own `.npmignore` for publishing
- [ ] Package has own `tsconfig.json`
- [ ] Package has comprehensive test suite
- [ ] Package has no direct imports from PorkAte core
- [ ] Package uses workspace protocol for inter-standalone deps
- [ ] Package documentation is complete
- [ ] Package has CI/CD workflow

### üì¶ Extraction-Ready Packages

| Package | Status | Version | Extraction-Ready |
|---------|--------|---------|------------------|
| `@invalid8/core` | ‚úÖ Ready | 1.0.0-alpha.1 | YES |
| `@townkrier/core` | ‚úÖ Ready | 1.0.0-alpha.1 | YES |
| `@kolo/core` | ‚úÖ Ready | 1.0.0-alpha.1 | YES |

---

## Benefits of This Architecture

### For Development

1. **Shared Tooling**: ESLint, Prettier, TypeScript configs shared
2. **Cross-Package Changes**: Make breaking changes across packages easily
3. **Single Install**: One `pnpm install` for everything
4. **Fast Builds**: Lerna caches and parallelizes builds

### For Publishing

1. **Independent Versions**: Each package versioned separately
2. **Selective Publishing**: Publish only changed packages
3. **Conventional Commits**: Automated changelog and version bumping

### For Users

1. **Install What You Need**: Use only the packages you need
2. **No Vendor Lock-in**: Standalone packages work independently
3. **Clear Dependencies**: Explicit dependency tree

### For Migration

1. **Zero-Change Extraction**: Packages ready to move as-is
2. **Git History Preservation**: Use git subtree to keep commit history
3. **Gradual Migration**: Extract packages one at a time

---

## Maintenance

### Adding New Standalone Package

1. Create directory in `standalone-packages/`
2. Add complete `package.json`
3. Add `README.md`, `LICENSE`, `.npmignore`
4. Add to `lerna.json` packages (if not using glob)
5. Follow extraction checklist above

### Updating Dependencies

```bash
# Update all dependencies
pnpm update -r

# Update specific package
cd standalone-packages/invalid8
pnpm update
```

### Clean Build

```bash
# Clean all packages
pnpm clean

# Clean build artifacts only
pnpm clean:build
```

---

## Troubleshooting

### Workspace Resolution Issues

If workspace dependencies aren't resolving:

```bash
# Clean everything
pnpm clean
rm -rf node_modules
rm pnpm-lock.yaml

# Reinstall
pnpm install
```

### Build Order Issues

Lerna automatically determines build order based on dependencies. If manual control needed:

```bash
# Build in specific order
lerna run build --scope=@townkrier/core
lerna run build --scope=@invalid8/core
lerna run build --scope=@kolo/core
lerna run build --scope=@porkate/core
```

### ZenStack Generation Issues

```bash
cd packages/core
pnpm zenstack:generate --verbose
```

---

## Additional Resources

- [Lerna Documentation](https://lerna.js.org/)
- [PNPM Workspaces](https://pnpm.io/workspaces)
- [ZenStack Documentation](https://zenstack.dev/)
- [Package Migration Guide](../migration/PACKAGE-MIGRATION-GUIDE.md)

---

**Last Updated:** October 24, 2025  
**Document Version:** 1.0  
**Maintainer:** Jeremiah Olisa
